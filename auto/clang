
# Copyright (C) Igor Sysoev
# Copyright (C) NGINX, Inc.


$echo checking for C compiler: $CC
cat << END >> $NJS_AUTOCONF_ERR
----------------------------------------
checking for C compiler: $CC
END


# Allow error exit status.
set +e

if [ -z `which $CC` ]; then
    $echo
    $echo $0: error: $CC not found.
    $echo
    exit 1;
fi


if `/bin/sh -c "($CC -v)" 2>&1 | grep "gcc version" >> $NJS_AUTOCONF_ERR 2>&1`
then
    NJS_CC_NAME=gcc
    $echo " + using GNU C compiler"
    NJS_CC_VERSION=`/bin/sh -c "($CC -v)" 2>&1 | grep "gcc version" 2>&1`
    $echo " + $NJS_CC_VERSION"

else
if `/bin/sh -c "($CC -v)" 2>&1 | grep "clang version" >> $NJS_AUTOCONF_ERR 2>&1`
then
    NJS_CC_NAME=clang
    $echo " + using Clang C compiler"
    NJS_CC_VERSION=`/bin/sh -c "($CC -v)" 2>&1 | grep "clang version" 2>&1`
    $echo " + $NJS_CC_VERSION"

else
if `/bin/sh -c "($CC -v)" 2>&1 \
                 | grep "Apple LLVM version" >> $NJS_AUTOCONF_ERR 2>&1`
then
    NJS_CC_NAME=clang
    $echo " + using Clang C compiler"
    NJS_CC_VERSION=`/bin/sh -c "($CC -v)" 2>&1 | grep "Apple LLVM version" 2>&1`
    $echo " + $NJS_CC_VERSION"

else
if `/bin/sh -c "($CC -V)" 2>&1 | grep "Sun C" >> $NJS_AUTOCONF_ERR 2>&1`
then
    NJS_CC_NAME=SunC
    $echo " + using Sun C compiler"
    NJS_CC_VERSION=`/bin/sh -c "($CC -V)" 2>&1 | grep "Sun C" 2>&1`
    $echo " + $NJS_CC_VERSION"

fi # SunC
fi # Apple LLVM clang
fi # clang
fi # gcc


case $NJS_CC_NAME in

    gcc)
        njs_define=NJS_GCC . auto/define

        NJS_CFLAGS="$NJS_CFLAGS -pipe"
        NJS_CFLAGS="$NJS_CFLAGS -fPIC"

        # Do not export symbols except explicitly marked with NJS_EXPORT.
        NJS_CFLAGS="$NJS_CFLAGS -fvisibility=hidden"

        # c99/gnu99 conflict with Solaris XOPEN.
        #NJS_CFLAGS="$NJS_CFLAGS -std=gnu99"

        NJS_CFLAGS="$NJS_CFLAGS -O"
        #NJS_CFLAGS="$NJS_CFLAGS -O0"
        NJS_CFLAGS="$NJS_CFLAGS -W -Wall -Wextra"

        #NJS_CFLAGS="$NJS_CFLAGS -Wunused-result"
        NJS_CFLAGS="$NJS_CFLAGS -Wno-unused-parameter"
        #NJS_CFLAGS="$NJS_CFLAGS -Wshorten-64-to-32"
        NJS_CFLAGS="$NJS_CFLAGS -Wwrite-strings"

        # -O2 enables -fstrict-aliasing and -fstrict-overflow.
        #NJS_CFLAGS="$NJS_CFLAGS -O2"
        #NJS_CFLAGS="$NJS_CFLAGS -Wno-strict-aliasing"

        #NJS_CFLAGS="$NJS_CFLAGS -fomit-frame-pointer"
        #NJS_CFLAGS="$NJS_CFLAGS -momit-leaf-frame-pointer"

        # -Wstrict-overflow is supported by GCC 4.2+.
        #NJS_CFLAGS="$NJS_CFLAGS -Wstrict-overflow=5"

        NJS_CFLAGS="$NJS_CFLAGS -Wmissing-prototypes"

        # Stop on warning.
        NJS_CFLAGS="$NJS_CFLAGS -Werror"

        # Debug.
        NJS_CFLAGS="$NJS_CFLAGS -g"
    ;;

    clang)
        njs_define=NJS_CLANG . auto/define

        NJS_CFLAGS="$NJS_CFLAGS -pipe"
        NJS_CFLAGS="$NJS_CFLAGS -fPIC"

        # Do not export symbols except explicitly marked with NJS_EXPORT.
        NJS_CFLAGS="$NJS_CFLAGS -fvisibility=hidden"

        NJS_CFLAGS="$NJS_CFLAGS -O"
        #NJS_CFLAGS="$NJS_CFLAGS -O0"
        NJS_CFLAGS="$NJS_CFLAGS -W -Wall -Wextra"

        #NJS_CFLAGS="$NJS_CFLAGS -Wunused-result"
        NJS_CFLAGS="$NJS_CFLAGS -Wno-unused-parameter"
        #NJS_CFLAGS="$NJS_CFLAGS -Wshorten-64-to-32"
        NJS_CFLAGS="$NJS_CFLAGS -Wwrite-strings"
        #NJS_CFLAGS="$NJS_CFLAGS -O2"
        #NJS_CFLAGS="$NJS_CFLAGS -fomit-frame-pointer"
        NJS_CFLAGS="$NJS_CFLAGS -fstrict-aliasing"
        NJS_CFLAGS="$NJS_CFLAGS -Wstrict-overflow=5"

        NJS_CFLAGS="$NJS_CFLAGS -Wmissing-prototypes"

        # Stop on warning.
        NJS_CFLAGS="$NJS_CFLAGS -Werror"

        # Debug.

        if [ "$NJS_SYSTEM_PLATFORM" != "powerpc" ]; then
            # "-g" flag causes the "unknown pseudo-op: `.cfi_sections'"
            # error on PowerPC Clang.
            NJS_CFLAGS="$NJS_CFLAGS -g"
        fi
    ;;

    SunC)
        njs_define=NJS_SUNC . auto/define

        NJS_CFLAGS="$NJS_CFLAGS -fPIC"
        # Optimization.
        NJS_CFLAGS="$NJS_CFLAGS -O -fast"
        # Stop on warning.
        NJS_CFLAGS="$NJS_CFLAGS -errwarn=%all"
        # Debug.
        NJS_CFLAGS="$NJS_CFLAGS -g"
    ;;

    *)
    ;;

esac

# Stop on error exit status again.
set -e

cat << END >> $NJS_MAKEFILE

NJS_CC =	${CC}
NJS_CFLAGS =	${NJS_CFLAGS} ${CFLAGS}
END


# C language features.

njs_feature="GCC unsigned __int128"
njs_feature_name=NJS_HAVE_UNSIGNED_INT128
njs_feature_run=no
njs_feature_incs=
njs_feature_libs=
njs_feature_test="int main(void) {
                      unsigned __int128 p = 0;
                      return (int) p;
                  }"
. auto/feature


njs_feature="GCC __builtin_expect()"
njs_feature_name=NJS_HAVE_BUILTIN_EXPECT
njs_feature_run=no
njs_feature_incs=
njs_feature_libs=
njs_feature_test="int main(int argc, char *const *argv) {
                      if ((__typeof__(argc == 0))
                                   __builtin_expect((argc == 0), 0))
                          return 0;
                      return 1;
                  }"
. auto/feature


njs_feature="GCC __builtin_unreachable()"
njs_feature_name=NJS_HAVE_BUILTIN_UNREACHABLE
njs_feature_run=no
njs_feature_incs=
njs_feature_libs=
njs_feature_test="int main(void) {
                      __builtin_unreachable();
                  }"
. auto/feature


njs_feature="GCC __builtin_prefetch()"
njs_feature_name=NJS_HAVE_BUILTIN_PREFETCH
njs_feature_run=no
njs_feature_incs=
njs_feature_libs=
njs_feature_test="int main(void) {
                      __builtin_prefetch(0);
                      return 0;
                  }"
. auto/feature


njs_feature="GCC __builtin_clz()"
njs_feature_name=NJS_HAVE_BUILTIN_CLZ
njs_feature_run=no
njs_feature_incs=
njs_feature_libs=
njs_feature_test="int main(void) {
                      if (__builtin_clz(1) != 31) {
                          return 1;
                      }
                      return 0;
                  }"
. auto/feature


njs_feature="GCC __builtin_clzll()"
njs_feature_name=NJS_HAVE_BUILTIN_CLZLL
njs_feature_run=no
njs_feature_incs=
njs_feature_libs=
njs_feature_test="int main(void) {
                      if (__builtin_clzll(1ULL) != 63) {
                          return 1;
                      }
                      return 0;
                  }"
. auto/feature


njs_feature="GCC __attribute__ visibility"
njs_feature_name=NJS_HAVE_GCC_ATTRIBUTE_VISIBILITY
njs_feature_run=no
njs_feature_path=
njs_feature_libs=
njs_feature_test="int n __attribute__ ((visibility(\"default\")));

                  int main(void) {
                      return 0;
                  }"
. auto/feature


njs_feature="GCC __attribute__ malloc"
njs_feature_name=NJS_HAVE_GCC_ATTRIBUTE_MALLOC
njs_feature_run=no
njs_feature_path=
njs_feature_libs=
njs_feature_test="#include <stdlib.h>

                  void *f(void) __attribute__ ((__malloc__));

                  void *f(void) {
                      return malloc(1);
                  }

                  int main(void) {
                      if (f() != NULL) {
                          return 1;
                      }
                      return 0;
                  }"
. auto/feature


njs_feature="GCC __attribute__ aligned"
njs_feature_name=NJS_HAVE_GCC_ATTRIBUTE_ALIGNED
njs_feature_run=no
njs_feature_path=
njs_feature_libs=
njs_feature_test="int n __attribute__ ((aligned(64)));

				  int main(void) {
					  return 0;
				  }"
. auto/feature


njs_feature="Memory sanitizer"
njs_feature_name=NJS_HAVE_MEMORY_SANITIZER
njs_feature_run=yes
njs_feature_incs=
njs_feature_libs=
njs_feature_test="#include <sanitizer/msan_interface.h>
                  int main(int argc, char *argv[]) {
                      __msan_unpoison(argv, sizeof(char *));
                      return 0;
                  }"
. auto/feature


njs_feature="NAN to uint conversion"
njs_feature_name=NJS_NAN_TO_UINT_CONVERSION
njs_feature_run=value
njs_feature_incs=
njs_feature_libs=-lm
njs_feature_test="#include <math.h>
                  #include <stdio.h>
                  #include <stdint.h>

                  int main(void) {
                      int64_t  i64 = acosh(0);
                      printf(\"%x\", (uint32_t) i64);
                      return 0;
                  }"
. auto/feature
